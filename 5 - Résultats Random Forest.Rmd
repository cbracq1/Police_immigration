---
title: "Random Forest"
author: "Bracq, Raymond"
date: "2024-04-16"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---


```{r}
#knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(haven)
library(tidyr)
library(tidyverse)
library(dplyr)
library(labelled)
library(survey)
library(arrow)
library(ggplot2)
library(questionr)
library(rpart)
library(rpart.plot)
library(forcats)
library(randomForest)
library(fastDummies)
library(visNetwork)
library(sparkline)

```

```{r}
source("Base.R")
```



```{r}
#Définition de la variable-cible : avoir au moins plutot confiance en la police
indiv["i_cnfpol_1"] = (indiv$i_cnfpol < 3)*1


#Filtrage des "Refus" et autres "Ne sait pas"
indiv <- indiv %>% filter(i_cnfpol < 8 & i_contri < 8 & l_quart_secu < 8 & l_immi < 8 & a_rquart < 8)

indiv <- indiv %>% drop_na(d_lieudisagr_d_rec)

```

```{r}
#On s'occupe des durar

durar = indiv$durar2
age = indiv$agenq

index_na = is.na(durar)

durar[index_na] = age[index_na]

indiv["durar2"] = durar



#Selection des varaibles à utiliser pour le modèle

#indiv_doi = indiv %>% select(c("ident","origine_tous_g2_class","i_cnfpol_1","sexee","group1_code","agenq","durar2","i_contri","l_quart_secu","l_immi","qpv_i","a_rquart","poidsi","discri","d_lieudisagr_d_rec","compor_discri"))


#indiv_doi <- dummy_cols(indiv, select_columns = c("origine_tous_g2_class","group1_code","compor_discri","d_lieudisagr_d_rec"))

#On retire les redondances
indiv_doi = indiv %>% dplyr::select(-c("origine_tous_g2_rec","origine_tous_g2_code","group1","group1_rec","taux_confiance","a_confiance","i_cnfpol_rec","i_cnfpol","uc_reve_isna","l_immi_code","a_rquart_code","i_cnfjus","i_ecole","i_contri","l_immi","a_rquart","qpv_i","l_quart_secu","sexee","f_dip","csnq_premp","csnq_ego","i_cnfjus_rec","i_ecole_rec"))

#"i_cnfjus_rec","i_ecole_rec"

#On retire les colonnes à NA
indiv_doi = indiv_doi[ , colSums(is.na(indiv_doi))==0]

```


```{r}
index_metro = which(indiv_doi$group1_code == "Autre")
index_immig = which(indiv_doi$group1_code == "G1_I")

indiv_ensem = indiv_doi[c(index_metro,index_immig),]


indiv_metro = indiv_doi[c(index_metro),]

indiv_immig = indiv_doi[c(index_immig),]

i_metro = which(indiv_ensem$group1_code == "Autre")
i_immig = which(indiv_ensem$group1_code == "G1_I")

```


```{r}

#Entrainement de la Random Forest (pop = Ensemble)

dataX = select(indiv_ensem,-one_of("ident","poidsi","i_cnfpol_1"))
target = indiv_ensem$i_cnfpol_1

rF=randomForest(x=dataX,y=target,ntree=100,weights=indiv_ensem$poidsi,importance=TRUE)



#Entrainement de la Random Forest (pop = metropolitain)
dataX_metro = select(indiv_metro,-one_of("ident","poidsi","i_cnfpol_1"))
target_metro = indiv_metro$i_cnfpol_1

rF_metro=randomForest(x=dataX_metro,y=target_metro,ntree=100,weights=indiv_metro$poidsi,importance=TRUE)



#Entrainement de la Random Forest (pop = immigrée)
dataX_immig = select(indiv_immig,-one_of("ident","poidsi","i_cnfpol_1"))
target_immig = indiv_immig$i_cnfpol_1

rF_immig=randomForest(x=dataX_immig,y=target_immig,ntree=100,weights=indiv_doi$poidsi[index_immig],importance=TRUE)



```

### a) Ensemble



```{r}
pr = predict(rF,dataX)

X = 0:100
Y = c()
Y1 = c()
Y0 = c()

for (i in X){
  
  prediction = (pr>(i/100))*1
  pred1 = prediction[which(target==1)]
  pred0 = prediction[which(target==0)]
  
  Y = c(Y,sum(prediction == target)/length(target))
  Y1 = c(Y1,sum(pred1 == 1)/sum(target==1))
  Y0 = c(Y0,sum(pred0 == 0)/sum(target==0))
  
}

Threshold = X
Accuracy = Y

littleforest = data.frame(X = Threshold, Y = Accuracy, Y1 = Y1, Y0 = Y0)

ggplot(littleforest,aes(x =Threshold))+
  geom_smooth(aes(y = Accuracy),color="black")+
  geom_smooth(aes(y = Y1),color="blue")+
  geom_smooth(aes(y=Y0),color="red")+
  ggtitle("Performance du modèle selon la threshold (pop = Ensemble)")

```

```{r}
#Choix de la threshold et évaluation du modèle

s = 75

print(Y[s+1])
print(Y1[s+1])
print(Y0[s+1])

prediction = as.vector((pr>(s/100))*1)

n_true_metro = 0
n_true_immig = 0
for (i in 1:length(prediction)){
  if (is.element(i,i_metro)){
    n_true_metro = n_true_metro + (prediction[i]==target[i])*1
  }
  else{ 
    if (is.element(i,i_immig)){
    n_true_immig = n_true_immig + (prediction[i]==target[i])*1
  }
  }
}

acc_metro = n_true_metro/length(i_metro)

acc_immig = n_true_immig/length(i_immig)

print(acc_metro)
print(acc_immig)

```



Threshold = 0.74

Prediction totale = 0.8806434

Prediction sur les "1" = 0.8796841
Prediction sur les "0" = 0.885203



Prediction sur les métropolitains = 0.9175725
Prediction sur les immigrés = 0.8540279



```{r}
# Les variables les plus importantes


pertinence1 = importance(rF,type=1)

dfp = data.frame(pertinence1)

listvar = rownames(dfp)[dfp["X.IncMSE"]>5.1]

```

### b) Metropolitains

```{r}
pr = predict(rF_metro,dataX)

X = 0:100
Y = c()
Y1 = c()
Y0 = c()

for (i in X){
  
  prediction = (pr>(i/100))*1
  pred1 = prediction[which(target==1)]
  pred0 = prediction[which(target==0)]
  
  Y = c(Y,sum(prediction == target)/length(target))
  Y1 = c(Y1,sum(pred1 == 1)/sum(target==1))
  Y0 = c(Y0,sum(pred0 == 0)/sum(target==0))
  
}

Threshold = X
Accuracy = Y

littleforest = data.frame(X = Threshold, Y = Accuracy, Y1 = Y1, Y0 = Y0)

ggplot(littleforest,aes(x =Threshold))+
  geom_smooth(aes(y = Accuracy),color="black")+
  geom_smooth(aes(y = Y1),color="blue")+
  geom_smooth(aes(y=Y0),color="red")+
  ggtitle("Performance du modèle selon la threshold (pop = metropolitaine)")

```

```{r}
#Choix de la threshold et évaluation du modèle

s = 58

print(Y[s+1])
print(Y1[s+1])
print(Y0[s+1])

```

### c) Immigrés

```{r}
pr = predict(rF_immig,dataX)

X = 0:100
Y = c()
Y1 = c()
Y0 = c()

for (i in X){
  
  prediction = (pr>(i/100))*1
  pred1 = prediction[which(target==1)]
  pred0 = prediction[which(target==0)]
  
  Y = c(Y,sum(prediction == target)/length(target))
  Y1 = c(Y1,sum(pred1 == 1)/sum(target==1))
  Y0 = c(Y0,sum(pred0 == 0)/sum(target==0))
  
}

Threshold = X
Accuracy = Y

littleforest = data.frame(X = Threshold, Y = Accuracy, Y1 = Y1, Y0 = Y0)

ggplot(littleforest,aes(x =Threshold))+
  geom_smooth(aes(y = Accuracy),color="black")+
  geom_smooth(aes(y = Y1),color="blue")+
  geom_smooth(aes(y=Y0),color="red")+
  ggtitle("Performance du modèle selon la threshold (pop = immigrée)")

```

```{r}
#Choix de la threshold et évaluation du modèle

s= 74

print(Y[s+1])
print(Y1[s+1])
print(Y0[s+1])

```


Nous constatons étonnament que les Random Forest sur les métropolitains et les immigrés sont en tout point moins performant que la Random Forest sur l'Ensemble : nous travaillerons donc à cette échelle.



## Arbre de décision visuel


```{r}

listvar =  c("anaise","agenq","arrivan","a_avis","x_moifr","x_apparf","coddipint","f_dis_flag","p_statsoc","s_alcfreq","pcs_ant","pcs_pere","dipdet","pcs_menage","d_lieudisagr_nbval","durar2","csnq_ego_rec","i_contri_rec","l_quart_secu_rec","origine_tous_g2_class","i_control_rec_d","i_control_rec_e","compor_discri")  

```

```{r}

#Selection des varaibles à utiliser pour l'arbre (nous modifions listvar pour eviter les redondances). On en profite aussi pour retirer la frequence de consommation d'alcool.

listvar_mieux = c(listvar[listvar != "s_alcfreq" & listvar != "coddipint" & listvar != "anaise" & listvar != "arrivan" & listvar != "pcs_pere"],c("ident","poidsi","i_cnfpol_1"))

indiv_tree = indiv_ensem %>% select(listvar_mieux)

indiv_tree <- indiv_tree %>% 
  mutate(controle_freq = case_when(i_contri_rec == "Jamais" ~ 1,
                                   i_contri_rec == "Une seule fois" ~ 2,
                                   i_contri_rec == "De 2 à 5 fois" ~ 3,
                                   i_contri_rec == "Plus de 5 fois" ~ 4))

indiv_tree <- indiv_tree %>% 
  mutate(secu_quartier = case_when(l_quart_secu_rec == "Bonne" ~ 3,
                                   l_quart_secu_rec == "Moyenne" ~ 2,
                                   l_quart_secu_rec == "Mauvaise" ~ 1))


indiv_tree <- indiv_tree %>% 
  mutate(comp_discr = case_when(compor_discri == "Discrimination dans le comportement de la police par le négatif" ~ "Négatif",
                                compor_discri == "Discrimination dans le comportement de la police par le positif" ~ "Positif",
                                compor_discri == "Pas de comportement discriminatoire lors du dernier contrôle" ~ "Absence"))

#Dummysons les variables catégorielles

indiv_tree <- dummy_cols(indiv_tree, select_columns = c("pcs_menage","pcs_ant","origine_tous_g2_class","csnq_ego_rec","comp_discr"))

indiv_tree <- indiv_tree %>% select(-c("compor_discri","l_quart_secu_rec","i_contri_rec","pcs_menage","pcs_ant","origine_tous_g2_class","csnq_ego_rec","compor_discri"))

```



```{r}
#Pour des arbres plus lisibles

{
indiv_arbre = indiv_tree

indiv_arbre["Nbre de lieux discrimiants"] = indiv_tree$d_lieudisagr_nbval
indiv_arbre["fouille de la police"] = indiv_tree$i_control_rec_d
indiv_arbre["provoc/insulte de la police"] = indiv_tree$i_control_rec_e
indiv_arbre["discri à l'école"] = indiv_tree$f_dis_flag
indiv_arbre["durée de séjour"] = indiv_tree$durar2
indiv_arbre["opinion niv de vie"] = indiv_tree$a_avis
indiv_arbre["age"]=indiv_tree$agenq
indiv_arbre["opinion statut social"]=indiv_tree$p_statsoc

indiv_arbre["sentiment français"] = indiv_tree$x_apparf
indiv_arbre["diplôme"] = indiv_tree$dipdet

indiv_arbre["chez moi en France"] = indiv_tree$x_moifr

indiv_arbre <- indiv_arbre %>% select(-c("d_lieudisagr_nbval","i_control_rec_d","i_control_rec_e",
                                         "f_dis_flag","durar2","a_avis","agenq",
                                         "p_statsoc","x_apparf","dipdet","x_moifr"))

}

indiv_tree=indiv_arbre

```


```{r}
data_tree = select(indiv_tree,-one_of("ident","poidsi","i_cnfpol_1"))
target_tree = indiv_tree$i_cnfpol_1

fitree <- rpart(target_tree~., data = data_tree, method = 'class', weights = indiv_tree$poidsi, control = rpart.control(cp = 0.005))


visTree(fitree)
```




```{r}

dpr_tree = data.frame(predict(fitree,data_tree))

s = 50

prediction_tree = (dpr_tree$X1>s/100)*1

pred_tree1 = prediction_tree[which(target_tree==1)]
pred_tree0 = prediction_tree[which(target_tree==0)]

print(sum(prediction_tree == target_tree)/length(target_tree))
print(sum(pred_tree1 == 1)/sum(target_tree==1))
print(sum(pred_tree0 == 0)/sum(target_tree==0))

```
# b) Métropolitain

```{r}
indiv_tree_m = indiv_tree[c(i_metro),]
``` 

```{r}
data_tree = select(indiv_tree_m,-one_of("ident","poidsi","i_cnfpol_1"))
target_tree = indiv_tree_m$i_cnfpol_1

fitree <- rpart(target_tree~., data = data_tree, method = 'class', weights = indiv_tree_m$poidsi, control = rpart.control(cp = 0.005))


visTree(fitree)
```



```{r}
dpr_tree = data.frame(predict(fitree,data_tree))

s = 50

prediction_tree = (dpr_tree$X1>s/100)*1

pred_tree1 = prediction_tree[which(target_tree==1)]
pred_tree0 = prediction_tree[which(target_tree==0)]

print(sum(prediction_tree == target_tree)/length(target_tree))
print(sum(pred_tree1 == 1)/sum(target_tree==1))
print(sum(pred_tree0 == 0)/sum(target_tree==0))
```


#c) Immigrés

```{r}
indiv_tree_i = indiv_tree[c(i_immig),]
``` 

```{r}
data_tree = select(indiv_tree_i,-one_of("ident","poidsi","i_cnfpol_1"))
target_tree = indiv_tree_i$i_cnfpol_1

fitree <- rpart(target_tree~., data = data_tree, method = 'class', weights = indiv_tree_i$poidsi, control = rpart.control(cp = 0.002))


visTree(fitree)
```

```{r}
dpr_tree = data.frame(predict(fitree,data_tree))

s = 50

prediction_tree = (dpr_tree$X1>s/100)*1

pred_tree1 = prediction_tree[which(target_tree==1)]
pred_tree0 = prediction_tree[which(target_tree==0)]

print(sum(prediction_tree == target_tree)/length(target_tree))
print(sum(pred_tree1 == 1)/sum(target_tree==1))
print(sum(pred_tree0 == 0)/sum(target_tree==0))
```

# Etude du cluster 1.3.1 (tout à droite)

```{r}

origine = indiv[c(index_immig),]["origine_tous_g2_rec"]

indiv_tree_i_org = indiv_tree_i
indiv_tree_i_org["origine"] = origine

ba=indiv_tree_i_org[which(indiv_tree_i$i_control_rec_d < 0.5 & indiv_tree_i$d_lieudisagr_nbval < 1.5),]


ba_pd = svydesign(ids = ba$ident, data = ba, weights = ba$poidsi)



tb1 <- data.frame(cprop(svytable(~i_cnfpol_1+origine, ba_pd[which(ba_pd$variables$i_cnfpol_1 != "Refus ou ne sait pas")])))
tb2 <- filter(tb1,i_cnfpol_1 != "Total")

ggplot(tb2, aes(x = origine, y= Freq, fill = i_cnfpol_1)) +
  geom_bar(stat="identity")


tb1 <- data.frame(cprop(svytable(~origine+i_cnfpol_1, ba_pd[which(ba_pd$variables$origine != "Refus ou ne sait pas")])))
tb2 <- filter(tb1,origine != "Total")

ggplot(tb2, aes(x = i_cnfpol_1, y= Freq, fill = origine)) +
  geom_bar(stat="identity")

```




