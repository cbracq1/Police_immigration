---
title: "Random Forest"
author: "Bracq, Raymond"
date: "2024-04-16"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = FALSE}
library(haven)
library(tidyr)
library(tidyverse)
library(dplyr)
library(labelled)
library(survey)
library(arrow)
library(ggplot2)
library(questionr)
library(rpart)
library(rpart.plot)
library(forcats)
library(randomForest)
library(fastDummies)
library(visNetwork)
library(sparkline)

```

```{r base, include = FALSE}
source("Base.R")
```



```{r base, include = FALSE}
#DÃ©finition de la variable-cible : avoir au moins plutot confiance en la police
indiv["i_cnfpol_1"] = (indiv$i_cnfpol < 3)*1


#write_parquet(indiv,'C:/Users/3e3gr/OneDrive/Bureau/indiv.parquet')

```

```{r setup, include = FALSE}
#Filtrage des "Refus" et autres "Ne sait pas"
indiv <- indiv %>% filter(i_cnfpol < 8 & i_contri < 8 & l_quart_secu < 8 & l_immi < 8 & a_rquart < 8)

indiv <- indiv %>% drop_na(d_lieudisagr_d_rec)

```

```{r setup, include = FALSE}
#On s'occupe des durar

durar = indiv$durar2
age = indiv$agenq

index_na = is.na(durar)

durar[index_na] = age[index_na]

indiv["durar2"] = durar

```


```{r setup, include = FALSE}
indiv_doi = indiv %>% select(c("ident","origine_tous_g2_class","i_cnfpol_1","sexee","group1_code","agenq","durar2","i_contri","l_quart_secu","l_immi","qpv_i","a_rquart","poidsi","discri","d_lieudisagr_d_rec","compor_discri"))

indiv_doi <- dummy_cols(indiv_doi, select_columns = c("origine_tous_g2_class","group1_code","compor_discri","d_lieudisagr_d_rec"))
```



```{r setup, include=FALSE}


dataX = indiv_doi %>% select(-one_of("ident","origine_tous_g2_class","group1_code","poidsi","i_cnfpol_1"))
target = indiv_doi$i_cnfpol_1


rF=randomForest(x=dataX,y=target,ntree=1000,weights=indiv_doi$poidsi,importance=TRUE)


```

```{r setup, include=FALSE}
pr = predict(rF,dataX)
```

```{r setup, include=FALSE}

prediction = (pr>0.74)*1

pred1 = prediction[which(target==1)]
pred0 = prediction[which(target==0)]

print(sum(prediction == target)/length(target))
print(sum(pred1 == 1)/sum(target==1))
print(sum(pred0 == 0)/sum(target==0))

```

Prediction totale = 0.8463

Prediction sur les "1" = 0.9756
Prediction sur les "0" = 0.4071


```{r setup, include=FALSE}
#Rappel : 
# type=1 -> increasing mean of accuracy
# type=2 -> increasing mean of node purity

pertinence1 = importance(rF,type=1)
pertinence2 = importance(rF,type=2)
```

Par ordre d'importance pour IncMSE (pour 500 arbres) :

discri (79.76)
i_contri (76.78)
agenq (55.46)
durar2 (64.02)
l_immi (33.29)
l_quart_secu (27.70)
G1_I (30.89)
qpv_i (23.71)
G2_I (23.25)


Par ordre d'importance pour NodesPurity :

durar2 (478)
agenq (464)
l_immi (240)
a_rquart (233)
i_contri (197)
l_quart_secu (117)
discri (99.13)
sexee (81.6)



```{r setup, include=FALSE}
dfp = data.frame(pertinence1,pertinence2)

listvar = rownames(dfp)[dfp["X.IncMSE"]>20 | dfp["IncNodePurity"]>50]

```

```{r setup, include=FALSE}
fitree <- rpart(target~., data = dataX, method = 'class',control = rpart.control(cp = 0.002))
rpart.plot(fit, extra = 106)


visTree(fitree)
```

```{r stupe, include=FALSE}
pr_tree = predict(fitree,dataX)

dpr_tree = data.frame(pr_tree)


```

```{r setup, include=FALSE}

prediction_tree = (dpr_tree$X1>0.79)*1

pred_tree1 = prediction_tree[which(target==1)]
pred_tree0 = prediction_tree[which(target==0)]

print(sum(prediction_tree == target)/length(target))
print(sum(pred_tree1 == 1)/sum(target==1))
print(sum(pred_tree0 == 0)/sum(target==0))

```
